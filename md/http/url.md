# 浅谈从输入URL到页面加载完成发生了什么

> 总体来说分为以下几个过程  

1. DNS解析
2. TCP连接
3. 发送HTTP请求
4. 服务器处理请求并返回HTTP报文
5. 浏览器解析渲染页面
6. 结束


## 具体过程

### DNS解析

计算机的唯一标识是IP，输入网址的时候不可能输入ip地址，因为记不住，所以就要一个域名，故而一个网址到IP的转换就叫做DNS解析

#### 解析过程

首先在本地域名服务器中查询IP地址，如果没找到，本地服务器就会向根服务器发送一个请求，如果还是没有，就会向com顶级域名服务器发送一个请求，以此类推去寻找，直到最后本地服务器得到网址的IP地址，然后缓存到本地(供下次使用)。所以。网址的解析是这么一个过程
: . -> .com -> github.com. -> www.github.com. (.对应的就是根域名服务器，通常省略)

#### DNS优化
由于解析过程中存在多个请求(UDP,TCP请求)，太浪费时间，减少该过程的步骤就是DNS缓存

##### DNS缓存

缓存分为: 浏览器缓存，系统缓存，路由器缓存，IPS服务器缓存，根域名服务器缓存，顶级郁闷服务器缓存，主域名服务器缓存。

* 例如chrome中 :chorme://dns/ 中有dns缓存

##### DNS负载均衡
返回一个合适的机器的IP给用户，根据每台机器的负载量，用户地理位置等。这就叫DNS负载均衡，又叫DNS重定向。如(CDN)，DNS服务器会返回一个跟用户最近的点的IP地址给用户，CDN节点的服务器负责响应用户的请求，提供所需要的内容

### TCP连接
3次挥手，4次握手。  
HTTPS在传输数据之前需要客户端和服务器进行一次握手(TLS/SSL握手)，在握手过程中将确立双方加密传输数据的密码信息。TLS/SSL使用了非对称加密，对称加密以及hash等。HTTPS相对于HTTP比较安全，但是会带来时间上的损耗，如握手和加密等过程。

### HTTP请求
FE眼前的HTTP，主要发生在客户端。发送HTTP请求的过程就是构建HTTP请求报文并通过TCP协议中发送到服务的指定端口(80, 443)。  
HTTP请求报文分为3个部分: 请求行，请求报头，请求正文。

#### 请求行

> 格式: Method Request-URL HTTP-Version CRLF

```js
eg: GET index.html HTTP/1.1
```
常用的方法有: GET,POST,PUT,DELETE,OPTIONS.HEAD

#### 请求报头

请求报头允许客户端向服务器传递请求的附加信息和客户端自身的信息  
常见的请求报头有: Accept, Accetp-Charset, Accept-Encoding, Accept-Language, Content-Type, Authorization, Cookie, User-Agent等。

##### 请求正文

就是在POST, PUT的时候，客户端要向服务器传递数据。如: rest架构时候，数据一般为json, 所以就要设置Content-Type: application/json

### 服务器处理请求返回HTTP报文

dev眼前的HTTP，从固定的端口接受到TCP报文开始，对TCP连接进行处理，对HTTP协议进行解析，并按照报文格式进一步封装成HTTP Request对象。  
HTTP响应报文也是由三部分组成: 状态码, 响应报头和响应报文。


### 浏览器解析渲染页面

1. 浏览器是一个边解析边渲染的过程。首先浏览器解析HTML文件构建DOM树，然后解析CSS文件渲染树，等到渲染树构建完成后，浏览器开始布局渲染树并绘制到屏幕上。其中涉及到 <strong>回流(reflow)和重绘(repain)</strong>。因为DOM节点中的各个元素都是以盒模型的形式存在，都需要浏览器去计算其位置和大小，这个过程称为回流；当盒模型的位置，大小以及颜色，字体等确定后，浏览器开始绘制内容，这个过程为重绘。浏览器从首次加载必然会经过重绘和回流。

2. JS的解析是由浏览器中的JS引擎完成的。由于JS是单线程，也就是说，在同一个时间里面只能做一件事情，所有的任务都要排队完成。但是又存在一些非常消耗时间的任务，比如I/O的读写操作等等。所以需要一个机制来先处理排在后面的任务，这就说到了异步任务。JS的执行机制就可以看作一个主线程加上一个任务队列。同步任务在主线程上执行，异步任务放在任务队列中。所有的同步任务放在主线程中执行，就形成了一个执行栈；异步任务有了运行结果以后会在队列中放置一个事件；脚本依次执行执行栈，然后从队列中提取事件，运行任务队列中的任务，这个过程不断重复形成了事件循环(Event Loop)  

浏览器在解析的过程中，如果遇到外部请求，如img，iconfont,js等。CSS文件的加载不影响JS文件的加载，但是却影响JS文件的执行。JS代码执行前浏览器必须保证CSS文件已经下载并加载完毕。


## 总结

简单的了解一下过程，还需继续深入，待续。